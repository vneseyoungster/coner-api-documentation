<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Reference - Coner Backend</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body data-environment="development">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>Coner Backend API Reference</h1>
            <p class="version">Loading...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <!-- Navigation will be loaded dynamically -->
        </div>
    </nav>

    <!-- Main Content with Three-Column Layout -->
    <div class="page-layout">
        <!-- Left Sidebar Navigation -->
        <aside class="sidebar-left">
            <div class="sidebar-version">
                <div class="sidebar-version-label">Latest Version</div>
                <div class="sidebar-version-number">Loading...</div>
            </div>
            <nav class="sidebar-nav">
                <!-- Navigation will be loaded dynamically -->
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Breadcrumb Navigation -->
            <nav class="breadcrumb">
                <a href="index.html">Documentation</a>
                <span class="breadcrumb-separator">></span>
                <span class="breadcrumb-current">API Reference</span>
            </nav>

            <!-- Page Header with Actions -->
            <div class="page-header">
                <h1>API Reference</h1>
                <div class="page-actions">
                    <button class="copy-page-btn" onclick="copyPageUrl()">
                        <span>Copy page</span>
                        <span>&#9660;</span>
                    </button>
                </div>
            </div>

            <!-- Info Banner -->
            <div class="info-banner">
                <span class="info-banner-icon">i</span>
                <div class="info-banner-content" id="info-banner-content">
                    <p>Loading...</p>
                </div>
            </div>

            <!-- Public Endpoint Banner -->
            <div class="alert info" id="public-endpoint-banner">
                Loading...
            </div>

            <!-- Language Switcher -->
            <div class="language-switcher">
                <span>Code Examples:</span>
                <button class="lang-btn active" data-lang="javascript" onclick="switchAllCodeTabs('javascript')">JavaScript</button>
                <button class="lang-btn" data-lang="python" onclick="switchAllCodeTabs('python')">Python</button>
                <button class="lang-btn" data-lang="curl" onclick="switchAllCodeTabs('curl')">cURL</button>
            </div>

            <div class="container" id="api-content">
                <!-- API content will be loaded dynamically -->
                <div class="loading-indicator">
                    <p>Loading API documentation...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <div class="footer">
        <!-- Footer will be loaded dynamically -->
    </div>

    <!-- Scripts -->
    <script src="assets/scripts.js"></script>
    <script>
        // API Page Renderer
        const APIRenderer = {
            baseUrl: '',

            // Escape HTML to prevent XSS
            escapeHtml(str) {
                if (typeof str !== 'string') return str;
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            // Replace {{baseUrl}} placeholder in code examples
            replaceBaseUrl(code) {
                return code.replace(/\{\{baseUrl\}\}/g, this.baseUrl);
            },

            // Format JSON for display with syntax highlighting
            formatJson(obj) {
                if (obj === null) return '<span class="json-null">null</span>';
                const jsonStr = JSON.stringify(obj, null, 2);
                return jsonStr
                    .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                    .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
                    .replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
                    .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                    .replace(/: (null)/g, ': <span class="json-null">$1</span>');
            },

            // Get method badge class
            getMethodClass(method) {
                return method.toLowerCase();
            },

            // Render validation rules table
            renderValidationTable(validation) {
                if (!validation || validation.length === 0) return '';
                return `
                    <h4>Validation Rules</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Type</th>
                                <th>Required</th>
                                <th>Validation</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${validation.map(v => `
                                <tr>
                                    <td><code>${this.escapeHtml(v.field)}</code></td>
                                    <td>${this.escapeHtml(v.type)}</td>
                                    <td><span class="badge ${v.required ? 'required' : 'optional'}">${v.required ? 'Required' : 'Optional'}</span></td>
                                    <td>${v.rules}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            },

            // Render query params table
            renderQueryParamsTable(params) {
                if (!params || params.length === 0) return '';
                return `
                    <h4>Query Parameters</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Required</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${params.map(p => `
                                <tr>
                                    <td><code>${this.escapeHtml(p.name)}</code></td>
                                    <td>${this.escapeHtml(p.type)}</td>
                                    <td><span class="badge ${p.required ? 'required' : 'optional'}">${p.required ? 'Required' : 'Optional'}</span></td>
                                    <td>${p.description}${p.default !== undefined ? ` (default: ${p.default})` : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            },

            // Render path params table
            renderPathParamsTable(params) {
                if (!params || params.length === 0) return '';
                return `
                    <h4>Path Parameters</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${params.map(p => `
                                <tr>
                                    <td><code>${this.escapeHtml(p.name)}</code></td>
                                    <td>${this.escapeHtml(p.type)}</td>
                                    <td>${p.description}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            },

            // Render code examples with tabs
            renderCodeExamples(endpoint) {
                if (!endpoint.codeExamples) return '';

                const languages = ['javascript', 'python', 'curl'];
                const langLabels = {
                    javascript: 'JavaScript (Axios)',
                    python: 'Python (requests)',
                    curl: 'cURL'
                };

                return `
                    <h4>Request Example</h4>
                    <div class="code-examples-wrapper">
                        <div class="code-example-tabs">
                            ${languages.map((lang, i) => `
                                <button class="code-example-tab${i === 0 ? ' active' : ''}" data-lang="${lang}">${lang.charAt(0).toUpperCase() + lang.slice(1)}</button>
                            `).join('')}
                        </div>
                        ${languages.map((lang, i) => `
                            <div class="code-example-content${i === 0 ? ' active' : ''}" data-lang="${lang}">
                                <div class="code-block">
                                    <div class="code-header">
                                        <span>${langLabels[lang]}</span>
                                        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                                    </div>
                                    <pre>${this.escapeHtml(this.replaceBaseUrl(endpoint.codeExamples[lang] || ''))}</pre>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            // Render responses
            renderResponses(responses) {
                if (!responses || responses.length === 0) return '';

                return responses.map(resp => `
                    <h4>Response (${resp.status} ${resp.statusText})${resp.description ? ` - ${resp.description}` : ''}</h4>
                    ${resp.note ? `<p>${resp.note}</p>` : ''}
                    ${resp.body !== null ? `
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON Response</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre>${this.formatJson(resp.body)}</pre>
                        </div>
                    ` : ''}
                `).join('');
            },

            // Render a single endpoint
            renderEndpoint(endpoint) {
                let html = `
                    <div class="endpoint">
                        <div class="endpoint-header">
                            <span class="method ${this.getMethodClass(endpoint.method)}">${endpoint.method}</span>
                            <span class="endpoint-path">${this.escapeHtml(endpoint.path)}</span>
                        </div>
                        <p class="endpoint-description">${endpoint.description}</p>
                `;

                // Auth note
                if (endpoint.auth && endpoint.authNote) {
                    html += `
                        <div class="alert info">
                            <strong>Authentication Required:</strong> ${endpoint.authNote}
                        </div>
                    `;
                }

                // Warning
                if (endpoint.warning) {
                    html += `
                        <div class="alert warning">
                            <strong>Important:</strong> ${endpoint.warning}
                        </div>
                    `;
                }

                // Danger
                if (endpoint.danger) {
                    html += `
                        <div class="alert danger">
                            <strong>Locked Fields:</strong> ${endpoint.danger}
                        </div>
                    `;
                }

                // How it works
                if (endpoint.howItWorks) {
                    html += `
                        <h4>How It Works</h4>
                        <ol>
                            ${endpoint.howItWorks.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    `;
                }

                // Path params
                html += this.renderPathParamsTable(endpoint.pathParams);

                // Query params
                html += this.renderQueryParamsTable(endpoint.queryParams);

                // Request body
                if (endpoint.requestBody && !endpoint.requestBody._formField) {
                    html += `
                        <h4>Request Body${endpoint.requestNote ? ` <small>(${endpoint.requestNote})</small>` : ''}</h4>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre>${this.formatJson(endpoint.requestBody)}</pre>
                        </div>
                    `;
                } else if (endpoint.requestBody && endpoint.requestBody._formField) {
                    html += `
                        <h4>Request Body (${endpoint.contentType || 'multipart/form-data'})</h4>
                        <p><strong>Field:</strong> <code>${endpoint.requestBody._formField}</code></p>
                        <p>${endpoint.requestBody._note}</p>
                    `;
                }

                // Alternate request body
                if (endpoint.alternateRequestBody) {
                    html += `
                        <h4>Alternate Request Body (for "Match later")</h4>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre>${this.formatJson(endpoint.alternateRequestBody)}</pre>
                        </div>
                    `;
                }

                // Defaults
                if (endpoint.defaults) {
                    html += `
                        <h4>Default Values</h4>
                        <p>If no request body is provided:</p>
                        <ul>
                            ${endpoint.defaults.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    `;
                }

                // Validation
                html += this.renderValidationTable(endpoint.validation);

                // Notes
                if (endpoint.notes) {
                    html += `
                        <h4>Important Notes</h4>
                        <ul>
                            ${endpoint.notes.map(n => `<li>${n}</li>`).join('')}
                        </ul>
                    `;
                }

                // Code examples
                html += this.renderCodeExamples(endpoint);

                // Responses
                html += this.renderResponses(endpoint.responses);

                // Errors
                if (endpoint.errors) {
                    html += `
                        <h4>Error Responses</h4>
                        <ul>
                            ${endpoint.errors.map(e => `<li><code>${this.escapeHtml(e)}</code></li>`).join('')}
                        </ul>
                    `;
                }

                // Usage example
                if (endpoint.usageExample) {
                    html += `
                        <h4>${endpoint.usageExample.title}</h4>
                        <div class="code-block">
                            <div class="code-header">
                                <span>${endpoint.usageExample.language || 'Bash'}</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre>${this.escapeHtml(this.replaceBaseUrl(endpoint.usageExample.code))}</pre>
                        </div>
                    `;
                }

                html += `</div>`;
                return html;
            },

            // Render error section
            renderErrorSection(section) {
                let html = `<section id="${section.id}" class="section">
                    <h2>${section.title}</h2>
                `;

                // Error format
                if (section.errorFormat) {
                    html += `
                        <h3>${section.errorFormat.title}</h3>
                        <p>${section.errorFormat.description}</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre>${this.formatJson(section.errorFormat.example)}</pre>
                        </div>
                    `;
                }

                // Validation errors
                if (section.validationErrors) {
                    html += `
                        <h3>${section.validationErrors.title}</h3>
                        <p>${section.validationErrors.description}</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre>${this.formatJson(section.validationErrors.example)}</pre>
                        </div>
                    `;
                }

                // HTTP codes
                if (section.httpCodes) {
                    html += `
                        <h3>HTTP Status Codes</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Meaning</th>
                                    <th>Common Causes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${section.httpCodes.map(c => `
                                    <tr>
                                        <td><code>${c.code}</code></td>
                                        <td>${c.meaning}</td>
                                        <td>${c.description}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                // Common errors
                if (section.commonErrors) {
                    html += `<h3>Common Error Scenarios</h3>`;
                    section.commonErrors.forEach(err => {
                        html += `
                            <div class="alert ${err.type}">
                                <strong>${err.title}</strong>
                                <pre style="margin-top: 0.5rem; background: transparent; padding: 0;">${this.escapeHtml(err.example)}</pre>
                                <p style="margin-top: 0.5rem; margin-bottom: 0;"><strong>Solution:</strong> ${err.solution}</p>
                            </div>
                        `;
                    });
                }

                html += `</section>`;
                return html;
            },

            // Render a section
            renderSection(section) {
                // Handle error section specially
                if (section.isErrorSection) {
                    return this.renderErrorSection(section);
                }

                let html = `<section id="${section.id}" class="section">
                    <h2>${section.title}</h2>
                `;

                // Section description
                if (section.description) {
                    html += `<p>${section.description}</p>`;
                }

                // Danger alert
                if (section.danger) {
                    html += `
                        <div class="alert danger">
                            <strong>DEVELOPMENT ONLY:</strong> ${section.danger}
                        </div>
                    `;
                }

                // Info alert
                if (section.info) {
                    html += `
                        <div class="alert info">
                            ${section.info}
                        </div>
                    `;
                }

                // Additional info (purpose, security, etc.)
                if (section.additionalInfo) {
                    Object.values(section.additionalInfo).forEach(info => {
                        html += `<h3>${info.title}</h3>`;
                        if (info.content) {
                            html += `<p>${info.content}</p>`;
                        }
                        if (info.list) {
                            html += `<ul>${info.list.map(item => `<li>${item}</li>`).join('')}</ul>`;
                        }
                    });
                }

                // Endpoints
                if (section.endpoints) {
                    section.endpoints.forEach(endpoint => {
                        html += this.renderEndpoint(endpoint);
                    });
                }

                // Workflow
                if (section.workflow) {
                    html += `
                        <h3>${section.workflow.title}</h3>
                        <div class="alert ${section.workflow.type || 'info'}">
                            ${section.workflow.content}
                            <ol style="margin: 0.5rem 0 0 1.5rem;">
                                ${section.workflow.steps.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                    `;
                }

                html += `</section>`;
                return html;
            },

            // Main render function
            async render() {
                const apiConfig = await ConfigLoader.load('config/api-config.json');
                if (!apiConfig) {
                    document.getElementById('api-content').innerHTML = `
                        <div class="alert danger">
                            <strong>Error:</strong> Failed to load API configuration. Please refresh the page.
                        </div>
                    `;
                    return;
                }

                this.baseUrl = apiConfig.baseUrl;

                // Update page info
                document.getElementById('info-banner-content').innerHTML = `<p>${apiConfig.page.infoBanner}</p>`;
                document.getElementById('public-endpoint-banner').innerHTML = `<strong>Public Development Endpoint:</strong> ${apiConfig.page.publicEndpointBanner}`;

                // Render all sections
                let html = '';
                apiConfig.sections.forEach(section => {
                    html += this.renderSection(section);
                });

                document.getElementById('api-content').innerHTML = html;

                // Initialize code example tabs
                initCodeExampleTabs();

                // Build sidebar navigation
                buildSidebarNav();
                restoreNavState();
                initEnhancedScrollHighlight();
            }
        };

        // Language switcher
        function switchAllCodeTabs(language) {
            // Update button states
            document.querySelectorAll('.language-switcher .lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === language);
            });

            // Switch all code tabs
            document.querySelectorAll('.code-examples-wrapper').forEach(wrapper => {
                const tabs = wrapper.querySelectorAll('.code-example-tab');
                const contents = wrapper.querySelectorAll('.code-example-content');

                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.lang === language);
                });

                contents.forEach(content => {
                    content.classList.toggle('active', content.dataset.lang === language);
                });
            });
        }

        // Initialize page
        async function initAPIPage() {
            await initPage('api.html');
            await APIRenderer.render();
        }

        // Start
        initAPIPage();
    </script>
</body>
</html>
